name: Build Debug App (Dev)

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  ANDROID_SDK_ROOT: ${{ runner.tool_cache }}/android-sdk
  ANDROID_HOME: ${{ runner.tool_cache }}/android-sdk

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo (full depth)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Verify version catalog exists
        run: |
          echo "Checking version catalog..."
          if [ -f gradle/libs.versions.toml ]; then
            echo "Found libs.versions.toml"
            ls -l gradle/libs.versions.toml
          else
            echo "ERROR: gradle/libs.versions.toml not found"
            ls -la
            exit 1
          fi

      - name: Copy version catalog for included builds (CI fix)
        run: |
          echo "Ensuring /home/runner/work/gradle/libs.versions.toml exists..."
          sudo mkdir -p /home/runner/work/gradle
          sudo cp gradle/libs.versions.toml /home/runner/work/gradle/libs.versions.toml || true
          ls -l /home/runner/work/gradle/libs.versions.toml || true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Android SDK command-line tools & platforms
        run: |
          set -euo pipefail
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          mkdir -p "$ANDROID_SDK_ROOT"
          cd "$ANDROID_SDK_ROOT"

          # Download command line tools (linux). If this URL breaks in future, update to the latest
          CLI_ZIP=commandlinetools-linux.zip
          if [ ! -d "$ANDROID_SDK_ROOT/cmdline-tools" ]; then
            curl -fsSL -o "$CLI_ZIP" "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip"
            unzip -q "$CLI_ZIP" -d "$ANDROID_SDK_ROOT/cmdline-tools-temp"
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv "$ANDROID_SDK_ROOT/cmdline-tools-temp/cmdline-tools"/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
            rm -rf "$ANDROID_SDK_ROOT/cmdline-tools-temp" "$CLI_ZIP"
          fi

          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"

          # Install basic SDK components. Adjust platform/build-tools versions if your project needs different ones.
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-34" "build-tools;34.0.0" >/dev/null

          # Accept licenses
          yes | sdkmanager --licenses --sdk_root="$ANDROID_SDK_ROOT" || true

          echo "Installed SDK contents:"
          ls -la "$ANDROID_SDK_ROOT"
          sdkmanager --list --sdk_root="$ANDROID_SDK_ROOT" | head -n 40 || true

      - name: Add Android tools to PATH
        run: |
          echo "PATH before: $PATH"
          echo "${{ runner.tool_cache }}/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "${{ runner.tool_cache }}/android-sdk/platform-tools" >> $GITHUB_PATH
          echo "Added Android SDK to PATH"

      - name: Grant execute permission for Gradle
        run: chmod +x ./gradlew

      - name: Show Gradle info
        run: ./gradlew --version

      - name: Show repo root and important files (debug)
        run: |
          pwd
          echo "Repo root listing:"
          ls -la
          echo "Gradle settings:"
          sed -n '1,200p' settings.gradle || true
          echo "Gradle catalog exists:"
          ls -la gradle || true

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Assemble Debug (no strict checks)
        run: |
          set -euo pipefail
          ./gradlew assembleDebug -x lint -x detekt -x ktlint --no-daemon --stacktrace --info

      - name: Locate APKs
        run: |
          echo "=== APKs found ==="
          find . -name "*debug*.apk" -maxdepth 6 -print || true

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: |
            **/*debug*.apk

      - name: Upload Gradle problem reports (if any)
        if: failure() || always()
        uses: actions/upload-artifact@v4
        with:
          name: gradle-problems
          path: |
            build/reports/problems/** || build/reports/** || build/*.log || ""